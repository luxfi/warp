---
title: Signature Request API
description: P2P signature request and response types for warp message signing
---

# Signature Request API

Package: `github.com/luxfi/warp`

These types handle the P2P protocol for requesting and aggregating warp signatures from validators.

## Constants

```go
// SignatureHandlerID is the P2P handler ID for signature requests
const SignatureHandlerID = 0x12345678
```

---

## Types

### SignatureRequest

Request sent to validators asking them to sign a warp message.

```go
type SignatureRequest struct {
    Message       []byte // Unsigned message bytes to sign
    Justification []byte // Optional proof/justification for the message
}
```

### SignatureResponse

Response containing the validator's signature.

```go
type SignatureResponse struct {
    Signature []byte // BLS signature bytes (96 bytes)
}
```

---

## Functions

### MarshalSignatureRequest

```go
func MarshalSignatureRequest(req *SignatureRequest) ([]byte, error)
```

Serializes a signature request to binary format for P2P transmission.

**Example:**
```go
req := &warp.SignatureRequest{
    Message:       unsignedMsg.Bytes(),
    Justification: proof,
}
data, err := warp.MarshalSignatureRequest(req)
```

### UnmarshalSignatureRequest

```go
func UnmarshalSignatureRequest(data []byte) (*SignatureRequest, error)
```

Deserializes a signature request from binary format.

**Example:**
```go
req, err := warp.UnmarshalSignatureRequest(requestBytes)
if err != nil {
    return err
}
msg, err := warp.ParseUnsignedMessage(req.Message)
```

### MarshalSignatureResponse

```go
func MarshalSignatureResponse(resp *SignatureResponse) ([]byte, error)
```

Serializes a signature response to binary format.

### UnmarshalSignatureResponse

```go
func UnmarshalSignatureResponse(data []byte) (*SignatureResponse, error)
```

Deserializes a signature response from binary format.

---

## Handler Types

### SignatureHandler

Interface for handling signature requests.

```go
type SignatureHandler interface {
    Request(ctx context.Context, nodeID ids.NodeID, deadline time.Time, requestBytes []byte) ([]byte, error)
}
```

### SignatureCacher

Interface for caching signature handler backends.

```go
type SignatureCacher[K comparable, V any] interface {
    Get(key K) (V, bool)
    Put(key K, value V)
}
```

### NewCachedSignatureHandler

```go
func NewCachedSignatureHandler(
    cache SignatureCacher[ids.ID, []byte],
    backend Verifier,
    signer Signer,
) SignatureHandler
```

Creates a handler that caches signatures and uses a verifier backend.

**Parameters:**
- `cache` - Signature cache (keyed by message ID)
- `backend` - Verifier to validate requests before signing
- `signer` - Signer to create signatures

**Example:**
```go
handler := warp.NewCachedSignatureHandler(
    lru.NewCache[ids.ID, []byte](1000),
    myVerifierBackend,
    mySigner,
)
```

### SignatureHandlerAdapter

```go
type SignatureHandlerAdapter struct {
    handler SignatureHandler
}
```

Adapts a `SignatureHandler` to the `p2p.Handler` interface.

```go
func NewSignatureHandlerAdapter(handler SignatureHandler) *SignatureHandlerAdapter
```

**Example:**
```go
adapter := warp.NewSignatureHandlerAdapter(cachedHandler)

// Register with P2P router
router.RegisterHandler(warp.SignatureHandlerID, adapter)
```

---

## SignatureAggregator

Aggregates signatures from multiple validators.

```go
type SignatureAggregator struct {
    log    log.Logger
    client *p2p.Client
}
```

### NewSignatureAggregator

```go
func NewSignatureAggregator(log log.Logger, client *p2p.Client) *SignatureAggregator
```

Creates a new signature aggregator.

### AggregateSignatures

```go
func (s *SignatureAggregator) AggregateSignatures(
    ctx context.Context,
    message *Message,
    justification []byte,
    validators []*Validator,
    quorumNum uint64,
    quorumDen uint64,
) (*Message, *big.Int, *big.Int, error)
```

Collects signatures from validators until quorum is reached.

**Parameters:**
- `ctx` - Context for cancellation
- `message` - Warp message to get signatures for
- `justification` - Optional proof to include in requests
- `validators` - List of validators to query
- `quorumNum` / `quorumDen` - Quorum fraction (e.g., 2/3)

**Returns:**
- `*Message` - Message with aggregated signature
- `*big.Int` - Signed weight achieved
- `*big.Int` - Total validator weight
- `error` - Any error

**Example:**
```go
aggregator := warp.NewSignatureAggregator(log, p2pClient)

signedMsg, signedWeight, totalWeight, err := aggregator.AggregateSignatures(
    ctx,
    unsignedMsg,
    nil,
    validators,
    2, 3, // 2/3 quorum
)
if err != nil {
    return fmt.Errorf("failed to aggregate: %w", err)
}

log.Info("Aggregation complete",
    "signedWeight", signedWeight,
    "totalWeight", totalWeight,
)
```

---

## Complete Integration Example

```go
import (
    "context"
    
    "github.com/luxfi/ids"
    "github.com/luxfi/log"
    "github.com/luxfi/node/cache/lru"
    "github.com/luxfi/p2p"
    "github.com/luxfi/warp"
)

func SetupWarpP2P(
    router *p2p.Router,
    verifier warp.Verifier,
    signer warp.Signer,
    log log.Logger,
) (*warp.SignatureAggregator, error) {
    // Create signature cache
    sigCache := lru.NewCache[ids.ID, []byte](1000)
    
    // Create cached handler
    handler := warp.NewCachedSignatureHandler(sigCache, verifier, signer)
    
    // Adapt to P2P interface
    adapter := warp.NewSignatureHandlerAdapter(handler)
    
    // Register handler with router
    router.RegisterHandler(warp.SignatureHandlerID, adapter)
    
    // Create aggregator for outbound requests
    client := router.NewClient(warp.SignatureHandlerID)
    aggregator := warp.NewSignatureAggregator(log, client)
    
    return aggregator, nil
}
```

---

## Migration from lp118

If you were using `github.com/luxfi/p2p/lp118`, update imports:

| Old (lp118) | New (warp) |
|-------------|------------|
| `lp118.Verifier` | `warp.Verifier` |
| `lp118.SignatureRequest` | `warp.SignatureRequest` |
| `lp118.SignatureResponse` | `warp.SignatureResponse` |
| `lp118.NewCachedHandler` | `warp.NewCachedSignatureHandler` |
| `lp118.NewHandlerAdapter` | `warp.NewSignatureHandlerAdapter` |
| `lp118.HandlerID` | `warp.SignatureHandlerID` |
| `lp118.SignatureAggregator` | `warp.SignatureAggregator` |
| `lp118.MarshalSignatureRequest` | `warp.MarshalSignatureRequest` |
| `lp118.UnmarshalSignatureResponse` | `warp.UnmarshalSignatureResponse` |
